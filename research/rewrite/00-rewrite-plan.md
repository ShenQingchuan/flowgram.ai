# Vue 重写计划 (Rewrite Plan)

本文档旨在为使用 Vue 3 从零开始重写一个流程编排库提供一个清晰的、可执行的计划。

## 1. 核心设计哲学

我们的重写工作将遵循以下核心原则：

-   **渐进式增强 (Progressive Enhancement)**: 从一个最简单的 MVP (Minimum Viable Product) 开始，然后逐步迭代，添加更复杂的功能。避免像原始库一样，在一开始就引入过多的抽象和复杂性。
-   **Vue 生态优先 (Vue-Native First)**: 深度拥抱 Vue 3 的特性，特别是 Composition API 和 Reactivity System。用 Vue 的方式去思考和解决问题，而不是将另一个框架的模式强行翻译过来。
-   **轻量级核心，插件化扩展**: 借鉴原始库的最大优点。保持核心库的轻量和专注，所有附加功能都通过插件来实现。
-   **类型安全 (Type-Safe)**: 全程使用 TypeScript，提供优秀的类型定义和智能提示。

## 2. MVP (最小可行产品) 定义

MVP 的目标是尽快验证核心渲染链路的可行性。它应该包含以下最基本的功能：

-   **一个 `<FlowCanvas>` 组件**: 作为所有功能的入口。
-   **渲染静态节点**: 能够接收一个节点数组 (`nodes: Node[]`)，并通过 `v-for` 将它们渲染到画布上。节点的位置由其 `x`, `y` 坐标决定。
-   **自定义节点外观**: 支持通过 Vue 的插槽 (`slot`) 机制，让用户可以自定义节点的渲染模板。
    ```vue
    <FlowCanvas :nodes="nodes">
      <template #node="{ node }">
        <div class="my-custom-node">{{ node.label }}</div>
      </template>
    </FlowCanvas>
    ```
-   **视口（Viewport）管理**:
    -   支持鼠标拖拽平移画布。
    -   支持鼠标滚轮缩放画布。
-   **数据结构**:
    -   定义最基础的 `Node` 和 `Edge` (连线) 的 TypeScript 接口。
    -   MVP 阶段甚至可以**不包含**连线（Edge）的渲染，以求最简化。

**MVP 阶段不做的事情**:
-   节点的交互（拖拽、选中、删除）。
-   连线的渲染和交互。
-   插件系统。
-   变量引擎。
-   历史记录（撤销/重做）。

## 3. 详细迭代计划

在 MVP 完成后，我们将按照以下阶段进行迭代：

### Phase 1: 核心交互

-   **节点选中**: 实现单击选中节点，支持多选（按住 Shift/Ctrl）。
-   **节点拖拽**: 实现拖拽单个或多个选中节点来改变其位置。
-   **连线渲染**: 实现最基础的点到点直线渲染。
-   **响应式数据**: 节点和连线的数据应该是响应式的。当外部数据变化时，画布应自动更新。当用户在画布上操作（如拖拽节点）时，应能将变化同步回原始数据 (`v-model`)。

### Phase 2: 插件系统

-   **插件协议定义**: 定义插件的接口 (`Plugin` interface)，至少包含 `install` 方法。
-   **`use` 方法**: 在 `<FlowCanvas>` 上提供一个 `use(plugin)` 方法，用于注册插件。
-   **上下文 (Context)**: 创建一个贯穿画布的上下文对象，并通过 `provide/inject` 共享。插件可以通过这个上下文访问画布的核心状态和方法。
-   **实现第一个插件**: 将 Phase 1 中的"拖拽"功能重构为一个可插拔的 `DragPlugin`。

### Phase 3: 增强的渲染与布局

-   **自定义连线**: 支持通过插槽自定义连线的路径 (`path`) 和样式。
-   **布局算法**: 为"固定布局"模式引入布局算法。可以先实现一个简单的树状布局。
-   **图层 (Layers)**: 借鉴原始库的思路，将背景、连线、节点、交互辅助元素（如选择框）拆分到不同的组件/图层中，通过 `z-index` 管理。

### Phase 4: 变量引擎

-   **响应式核心**: 基于 Vue 的 `reactivity` API (`ref`, `computed`) 构建一个轻量级的 `VariableEngine`。
-   **作用域**: 实现 `Scope` 的概念，每个节点拥有自己的作用域。
-   **可用变量计算**: 实现 `available` 变量的计算逻辑，即合并当前作用域和其父级作用域的变量。
-   **集成**: 将变量引擎通过插件系统集成到画布中。

### Phase 5: 高级功能

-   **历史记录 (Undo/Redo)**: 实现一个 `HistoryPlugin`，监听所有可变操作，并提供撤销/重做功能。
-   **物料面板 (`Palette`)**: 提供一个独立的组件，用于展示可拖拽到画布中的新节点。
-   **小地图 (`Minimap`)**: 实现一个 `MinimapPlugin`。

通过这个循序渐进的计划，我们可以确保每一步都有明确的目标和可交付的成果，稳健地构建出一个强大而又不失简洁的 Vue 流程编排库。
